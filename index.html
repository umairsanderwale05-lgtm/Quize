<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Kids Learning Hub</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }

        .container {
            max-width: 95%;
            margin-top: 20px;
        }

        .speak-btn-loading,
        .chat-loading {
            /* Spin icon animation */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .chat-message-bot {
            border-radius: 12px 12px 12px 2px;
        }

        .chat-message-user {
            border-radius: 12px 12px 2px 12px;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div id="app-container" class="container bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-xl">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6 border-b-2 pb-2">‚≠ê Kids Learning Hub ‚≠ê</h1>

        <!-- Navigation Tabs -->
        <div class="flex justify-center mb-6 space-x-2">
            <button id="nav-quiz"
                class="py-2 px-4 rounded-lg font-semibold transition duration-150 bg-indigo-600 text-white shadow-md">
                üß† Quiz Time
            </button>
            <button id="nav-chat"
                class="py-2 px-4 rounded-lg font-semibold transition duration-150 bg-gray-200 text-gray-700 hover:bg-gray-300">
                üí¨ Kiddo Chatbot
            </button>
        </div>

        <!-- --- QUIZ AREA --- -->
        <div id="quiz-section">
            <!-- Loading Indicator -->
            <div id="loading-spinner" class="hidden text-center py-8">
                <svg class="animate-spin h-8 w-8 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <p class="mt-3 text-indigo-600 font-semibold">AI naye questions bana raha hai... Wait kijiye!</p>
            </div>

            <!-- Start Form (Visible Initially) -->
            <div id="start-form">
                <p class="text-gray-600 mb-6 text-center">Bacche ki details aur quiz options daaliye.</p>

                <div class="space-y-4">
                    <!-- Kid's Name Input -->
                    <div>
                        <label for="child-name" class="block text-sm font-medium text-gray-700">Bacche Ka Naam (Kid's
                            Name)</label>
                        <input type="text" id="child-name" value="Adi" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- Age and Class -->
                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="child-age" class="block text-sm font-medium text-gray-700">Bacche ki Age
                                (Years)</label>
                            <input type="number" id="child-age" min="3" max="15" value="7" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        <div class="w-1/2">
                            <label for="child-class" class="block text-sm font-medium text-gray-700">Class
                                Standard</label>
                            <input type="number" id="child-class" min="1" max="10" value="2" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div>
                        <label for="quiz-category" class="block text-sm font-medium text-gray-700">Quiz Category</label>
                        <select id="quiz-category"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="Mixed">Mixed Categories (Math, Science, etc.)</option>
                            <option value="Math">Math (Ganit)</option>
                            <option value="Science">Science (Vigyan/EVS)</option>
                            <option value="GK">General Knowledge</option>
                            <option value="Animals">Animals & Birds</option>
                        </select>
                    </div>

                    <!-- Language Selection -->
                    <div>
                        <label for="quiz-language" class="block text-sm font-medium text-gray-700">Quiz Language</label>
                        <select id="quiz-language"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="Hinglish">Hinglish (Hindi/English mix)</option>
                            <option value="Hindi">Hindi</option>
                            <option value="English">English</option>
                        </select>
                    </div>
                </div>

                <button id="start-quiz-btn"
                    class="w-full mt-8 py-3 px-4 border border-transparent rounded-lg shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out font-bold">
                    üöÄ Start Quiz!
                </button>
            </div>

            <!-- Quiz Area (Hidden Initially) -->
            <div id="quiz-area" class="hidden">
                <!-- Personalized Greeting -->
                <h2 id="personalized-greeting"
                    class="text-xl font-bold text-center text-green-700 bg-green-100 py-2 rounded-lg mb-4 shadow-sm">
                </h2>

                <div id="score-display"
                    class="text-base font-semibold text-center mb-4 p-2 rounded-lg bg-indigo-100 text-indigo-700 flex justify-between">
                    <span>Score: 0 / 0</span>
                    <span id="coins-display">üí∞ Coins: 0</span>
                </div>

                <div id="question-card" class="bg-white p-6 rounded-xl shadow-lg border border-indigo-200">
                    <p id="question-number" class="text-sm font-medium text-indigo-500 mb-2">Question 1 of 10</p>

                    <div class="flex items-center space-x-3 mb-5">
                        <p id="question-text" class="text-xl font-bold text-gray-800">Loading question...</p>
                        <!-- Speak Question Button -->
                        <button id="speak-question-btn"
                            class="text-indigo-600 hover:text-indigo-800 focus:outline-none p-1 rounded-full bg-indigo-100 transition duration-150"
                            aria-label="Read question aloud">
                            <!-- Speaker Icon (lucide-react icon) -->
                            <svg id="speak-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                                <path
                                    d="M15.5 22a2.5 2.5 0 0 1-2.5-2.5v-7.5a2.5 2.5 0 0 1 5 0v7.5a2.5 2.5 0 0 1-2.5 2.5z" />
                                <path d="M10 18H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-5" />
                            </svg>
                        </button>
                    </div>

                    <div id="options-container" class="space-y-3">
                        <!-- Options will be inserted here -->
                    </div>

                    <div class="mt-6 flex justify-between items-center">
                        <p id="feedback-message" class="font-medium"></p>
                        <button id="next-question-btn" disabled
                            class="py-2 px-6 rounded-lg bg-gray-400 text-white font-semibold transition duration-150 ease-in-out cursor-not-allowed">
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Result Area (Hidden Initially) -->
            <div id="result-area"
                class="hidden text-center p-8 bg-green-50 rounded-xl shadow-lg border border-green-300">
                <h2 class="text-2xl font-extrabold text-green-700 mb-4">üèÜ Quiz Complete! Bahut Acche!</h2>
                <p id="final-score" class="text-4xl font-black text-indigo-600 mb-2">Score: 0 / 10</p>
                <p id="final-coins" class="text-2xl font-black text-yellow-600 mb-6">üí∞ Total Coins: 0</p>
                <p id="result-message" class="text-lg text-gray-700 mb-8"></p>
                <button id="restart-quiz-btn"
                    class="py-3 px-8 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition duration-150">
                    Start Naya Quiz
                </button>
            </div>
        </div>

        <!-- --- CHATBOT AREA (Hidden Initially) --- -->
        <div id="chat-section" class="hidden h-[500px] flex flex-col">
            <h2 class="text-xl font-bold text-center text-indigo-700 mb-4">üí¨ Kiddo Bot Se Poocho!</h2>
            <div id="chat-messages"
                class="flex-grow overflow-y-auto space-y-4 p-4 bg-gray-50 rounded-lg mb-4 border border-gray-200">
                <!-- Initial Bot Message -->
                <div class="flex justify-start">
                    <div class="bg-indigo-100 p-3 chat-message-bot max-w-[80%] shadow-sm text-gray-800">
                        <span class="font-bold text-indigo-600">Kiddo Bot:</span> Hi, main hoon Kiddo Bot! ü§ó Aapka kya
                        sawal hai? Main aapki help karunga!
                    </div>
                </div>
            </div>

            <!-- Chat Input Form -->
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="chat-input" placeholder="Yahan apna sawal type karo..." required
                    class="flex-grow p-3 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <button type="submit" id="chat-send-btn"
                    class="p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="w-6 h-6">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </form>
        </div>


    </div>

    <script type="module">
        // --- Firebase Imports (Keeping standard for real apps) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Environment variables
        // ***************************************************************
        // Boss, AGAR AAP APNE MACHINE PAR CHALA RAHE HAIN,
        // TOH NICHE WALE BLANK QUOTES ("") KE ANDAR APNI API KEY DAALIYE.
        // ***************************************************************
        const apiKey = "AIzaSyBKguZBHiEBdw76OxKpCsPV9v0ECsMwFY8"; // <--- APNI GEMINI API KEY YAHAN DAALIYE

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anonymous';

        // Initialize Firebase
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
            }
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        async function authenticateUser() {
            try {
                if (auth) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userId = crypto.randomUUID();
            }
        }

        if (auth) {
            authenticateUser();
        }

        // --- Core Quiz Variables & DOM Elements ---
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let coins = 0;
        let currentSelection = null;
        let audioPlayer = new Audio();

        // Section & Nav
        const quizSection = document.getElementById('quiz-section');
        const chatSection = document.getElementById('chat-section');
        const navQuiz = document.getElementById('nav-quiz');
        const navChat = document.getElementById('nav-chat');

        // Quiz DOM
        const startFormDiv = document.getElementById('start-form');
        const quizAreaDiv = document.getElementById('quiz-area');
        const resultAreaDiv = document.getElementById('result-area');
        const loadingSpinner = document.getElementById('loading-spinner');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const optionsContainer = document.getElementById('options-container');
        const feedbackMessage = document.getElementById('feedback-message');
        const coinsDisplay = document.getElementById('coins-display');
        const speakQuestionBtn = document.getElementById('speak-question-btn');
        const speakIcon = document.getElementById('speak-icon');
        const personalizedGreeting = document.getElementById('personalized-greeting'); // NEW ELEMENT

        // Chat DOM
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const sendIcon = document.getElementById('send-icon');


        // --- Sound Setup (Tone.js) ---
        let correctSynth, wrongSynth, coinSynth;
        let isToneInitialized = false;

        function initializeTone() {
            try {
                if (typeof Tone !== 'undefined' && !isToneInitialized) {
                    // Correct answer sound (Plop)
                    correctSynth = new Tone.MembraneSynth({
                        pitchDecay: 0.05, octaves: 1, volume: -10,
                        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.8 },
                    }).toDestination();

                    // Wrong answer sound (Noise)
                    wrongSynth = new Tone.NoiseSynth({
                        volume: -10,
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0 },
                    }).toDestination();

                    // Coin Sound (Chime/Pluck) - FIXED FOR BETTER AUDIBILITY
                    coinSynth = new Tone.MetalSynth({
                        frequency: 200, volume: -15,
                        envelope: { attack: 0.001, decay: 0.2, release: 0.1 },
                        harmonicity: 3.1, modulationIndex: 10,
                        octaves: 1, resonance: 4000,
                    }).toDestination();
                    isToneInitialized = true;
                }
            } catch (e) {
                console.error("Tone.js setup failed:", e);
            }
        }

        // Must call Tone.start() on first user interaction
        document.body.addEventListener('click', () => {
            if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                Tone.start();
            }
        }, { once: true });


        function playCorrectSound() {
            if (correctSynth && isToneInitialized) { correctSynth.triggerAttackRelease("C5", "8n"); }
        }

        function playCoinSound() {
            if (coinSynth && isToneInitialized) {
                coinSynth.triggerAttackRelease("G5", "16n", Tone.now());
                coinSynth.triggerAttackRelease("B5", "16n", Tone.now() + 0.05); // Short arpeggio for chime
            }
        }

        function playWrongSound() {
            if (wrongSynth && isToneInitialized) { wrongSynth.triggerAttackRelease("4n"); }
        }

        // --- Utility Functions ---

        /** Exponential Backoff for API retries */
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    return response;
                } catch (error) {
                    if (i === retries - 1) { throw error; }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    console.warn(`API call failed, retrying in ${delay / 1000}s...`);
                }
            }
        }

        // --- TTS Helper Functions (Unchanged) ---

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const dataLength = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); }
            }
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
            writeString(view, 36, 'data'); view.setUint32(40, dataLength, true);
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        async function readQuestionAloud(questionText) {
            if (!questionText) return;

            speakQuestionBtn.disabled = true;
            speakQuestionBtn.classList.add('speak-btn-loading');
            speakIcon.innerHTML = `<svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const voiceName = "Kore";
            const prompt = `Read the following kid's quiz question in a friendly, clear, and encouraging tone: ${questionText}`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceName } }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];

                if (!part || !part.inlineData || !part.inlineData.data) { throw new Error("TTS API did not return audio data."); }

                const audioData = part.inlineData.data;
                const mimeType = part.inlineData.mimeType;
                const rateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;

                const pcmBuffer = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmBuffer);
                const wavBlob = pcmToWav(pcm16, sampleRate);

                const audioUrl = URL.createObjectURL(wavBlob);
                audioPlayer.src = audioUrl;
                audioPlayer.play();

            } catch (error) {
                console.error("TTS failed:", error);
                // Removed alertUser to prevent blocking but kept console error
            } finally {
                speakQuestionBtn.classList.remove('speak-btn-loading');
                speakIcon.innerHTML = `<path d="M15.5 22a2.5 2.5 0 0 1-2.5-2.5v-7.5a2.5 2.5 0 0 1 5 0v7.5a2.5 2.5 0 0 1-2.5 2.5z" /><path d="M10 18H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-5" />`;
                speakQuestionBtn.disabled = false;
            }
        }

        // --- Question Generation Logic (Simplified/Updated) ---
        async function generateQuizQuestions(age, standard, category, language) {

            const userQuery = `Generate exactly 10 multiple-choice questions for a child who is ${age} years old and in Class ${standard}. Focus strictly on the category: ${category}. Ensure the questions are simple and easy to understand. The quiz must be in ${language}.`;

            const systemPrompt = "You are an educational quiz generator for young children. Generate exactly 10 multiple-choice questions (4 options each) suitable for the specified age and class standard. You MUST also provide a simple, one-sentence logic/reason for the correct answer. Provide the output strictly as a JSON array.";

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const responseSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "question": { "type": "STRING" },
                        "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                        "correct_answer": { "type": "STRING" },
                        "category": { "type": "STRING" },
                        "reason": { "type": "STRING" }
                    },
                    required: ["question", "options", "correct_answer", "category", "reason"]
                }
            };


            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    })
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonText) { throw new Error("AI did not return valid content."); }

                let parsedJson = JSON.parse(jsonText);
                return Array.isArray(parsedJson) ? parsedJson : [];

            } catch (error) {
                console.error("Gemini API call failed:", error);
                alertUser("Error: Quiz questions generate nahi ho paye. Console dekhiye.");
                return [];
            }
        }


        /** Quiz UI Functions (Simplified/Updated) **/

        function renderQuestion() {
            feedbackMessage.textContent = '';
            nextQuestionBtn.classList.replace('bg-indigo-600', 'bg-gray-400');
            nextQuestionBtn.classList.remove('hover:bg-indigo-700', 'cursor-pointer');
            nextQuestionBtn.classList.add('cursor-not-allowed');
            nextQuestionBtn.disabled = true;

            if (currentQuestionIndex < quizQuestions.length) {
                const q = quizQuestions[currentQuestionIndex];
                document.getElementById('question-number').textContent = `Question ${currentQuestionIndex + 1} of ${quizQuestions.length} (Category: ${q.category})`;
                document.getElementById('question-text').textContent = q.question;
                optionsContainer.innerHTML = '';
                currentSelection = null;

                speakQuestionBtn.onclick = () => readQuestionAloud(q.question);

                q.options.forEach((option) => {
                    const button = document.createElement('button');
                    button.textContent = option;
                    button.className = 'w-full text-left py-3 px-4 rounded-lg bg-indigo-50 border border-indigo-200 text-gray-800 hover:bg-indigo-200 transition duration-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 font-medium option-btn';
                    button.setAttribute('data-answer', option);
                    button.onclick = () => selectOption(button, q.correct_answer);
                    optionsContainer.appendChild(button);
                });
            } else {
                showResult();
            }

            updateScoreDisplay();
        }

        function selectOption(selectedButton, correctAnswer) {
            if (currentSelection) return;

            const q = quizQuestions[currentQuestionIndex];
            currentSelection = selectedButton.getAttribute('data-answer');
            const isCorrect = currentSelection === correctAnswer;

            // Disable all options
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.onclick = null;
                btn.classList.remove('hover:bg-indigo-200');
            });

            selectedButton.classList.remove('bg-indigo-50', 'border-indigo-200');
            selectedButton.classList.add('ring-4');

            if (isCorrect) {
                score++;
                coins += 10;
                playCorrectSound();
                playCoinSound(); // <-- Coin sound
                selectedButton.classList.add('bg-green-200', 'ring-green-500');
                feedbackMessage.textContent = "‚úÖ Correct Answer! 10 Coins mile! Bahut Badhiya!";
                feedbackMessage.classList.remove('text-red-600');
                feedbackMessage.classList.add('text-green-600');
            } else {
                playWrongSound();
                selectedButton.classList.add('bg-red-200', 'ring-red-500');
                document.querySelector(`.option-btn[data-answer="${correctAnswer}"]`).classList.add('bg-green-300', 'ring-green-500', 'border-green-500');

                const reasonText = q.reason ? ` Reason: ${q.reason}` : '';
                feedbackMessage.innerHTML = `‚ùå Wrong! Correct answer hai: <strong>${correctAnswer}</strong>.<br class="sm:hidden"> ${reasonText}`;
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-600');
            }

            nextQuestionBtn.disabled = false;
            nextQuestionBtn.classList.replace('bg-gray-400', 'bg-indigo-600');
            nextQuestionBtn.classList.add('hover:bg-indigo-700', 'cursor-pointer');
            nextQuestionBtn.classList.remove('cursor-not-allowed');
            updateScoreDisplay();
        }

        function updateScoreDisplay() {
            document.getElementById('score-display').querySelector('span:first-child').textContent = `Score: ${score} / ${currentQuestionIndex + (currentSelection ? 1 : 0)}`;
            coinsDisplay.textContent = `üí∞ Coins: ${coins}`;
        }

        function showResult() {
            quizAreaDiv.classList.add('hidden');
            resultAreaDiv.classList.remove('hidden');
            document.getElementById('final-score').textContent = `Score: ${score} / ${quizQuestions.length}`;
            document.getElementById('final-coins').textContent = `üí∞ Total Coins: ${coins}`;

            let message = '';
            const percentage = (score / quizQuestions.length) * 100;
            if (percentage === 100) {
                message = "Waah! Aap toh Genius hain! Saare sawaal sahi kiye! üåü";
            } else if (percentage >= 70) {
                message = "Shaandaar performance! Thoda aur focus kijiye aur aap 100% score kar lenge! üëç";
            } else {
                message = "Achha try kiya! Agli baar aur acche se padh kar aana! Aap zaroor seekhenge! üí™";
            }
            document.getElementById('result-message').textContent = message;
        }

        async function handleStartQuiz() {
            initializeTone(); // Initialize Tone.js here on a user gesture

            // --- UPDATED VALIDATION LOGIC ---
            const nameInput = document.getElementById('child-name'); // NEW
            const ageInput = document.getElementById('child-age');
            const classInput = document.getElementById('child-class');

            const childName = nameInput.value.trim(); // NEW
            const age = parseInt(ageInput.value, 10);
            const standard = parseInt(classInput.value, 10);

            const category = document.getElementById('quiz-category').value;
            const language = document.getElementById('quiz-language').value;

            if (!childName || isNaN(age) || age < 3 || isNaN(standard) || standard < 1) {
                console.error("Please enter a valid Name, Age (min 3) and Class (min 1).");
                alertUser("Kripya sahi Naam, Age (minimum 3) aur Class (minimum 1) daaliye.");
                return;
            }
            // --- END VALIDATION ---

            if (!apiKey) {
                alertUser("Error: API Key missing! Please daaliye apni Gemini API Key code ke andar.");
                return;
            }

            score = 0;
            coins = 0;
            startFormDiv.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            // Set Personalized Greeting
            personalizedGreeting.textContent = `Hello, ${childName}! Shuru karte hain quiz! Good Luck! üçÄ`;

            quizQuestions = await generateQuizQuestions(age, standard, category, language);

            loadingSpinner.classList.add('hidden');

            if (quizQuestions.length > 0) {
                currentQuestionIndex = 0;
                quizAreaDiv.classList.remove('hidden');
                renderQuestion();
            } else {
                // If generation fails, show start form again
                startFormDiv.classList.remove('hidden');
            }
        }

        // --- Chatbot Logic ---

        // Helper to scroll to the bottom of the chat
        function scrollChatToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Display User Message
        function appendUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            messageDiv.innerHTML = `
                <div class="bg-blue-500 text-white p-3 chat-message-user max-w-[80%] shadow-md">
                    ${text}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollChatToBottom();
        }

        // Display Bot Message
        function appendBotMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start';
            messageDiv.innerHTML = `
                <div class="bg-indigo-100 p-3 chat-message-bot max-w-[80%] shadow-md text-gray-800">
                    <span class="font-bold text-indigo-600">Kiddo Bot:</span> ${text}
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollChatToBottom();
        }

        // Handle Chat Submission
        async function handleChatSubmit(event) {
            event.preventDefault();
            const userQuery = chatInput.value.trim();
            if (!userQuery) return;

            if (!apiKey) {
                alertUser("Error: API Key missing! Chatbot ke liye bhi key chahiye. Console dekhiye.");
                appendBotMessage("Sorry, meri API Key missing hai. Main abhi baat nahi kar sakta. üò•");
                return;
            }

            appendUserMessage(userQuery);
            chatInput.value = '';

            // Loading state
            chatSendBtn.disabled = true;
            sendIcon.classList.add('chat-loading');
            sendIcon.innerHTML = `<svg class="animate-spin h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a friendly, encouraging, and highly knowledgeable tutor named 'Kiddo Bot'. Your goal is to answer children's questions simply, clearly, and positively, always using Hindi/Hinglish (mix of Hindi and English). Use emojis in every response to make it fun. Be brief and to the point. Since you are talking to a child, use simple vocabulary. Always use Google Search for current information.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, Boss. Main abhi jawab nahi de paa raha hoon. Ek baar phir try karo. üò•";

                appendBotMessage(responseText);

            } catch (error) {
                console.error("Chat API failed:", error);
                appendBotMessage("Oops! Network issue aa gaya. Please check your connection aur dobara try karo. üîå");
            } finally {
                chatSendBtn.disabled = false;
                sendIcon.classList.remove('chat-loading');
                sendIcon.innerHTML = `<line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>`;
            }
        }

        // Re-using the utility function to show error without blocking alerts
        function alertUser(message) {
            console.error(message);
            // Instead of blocking alert(), you can optionally show a temporary message in the UI if needed
            // For now, sticking to console.error
        }

        // --- Navigation and Event Listeners ---

        function switchSection(sectionId) {
            quizSection.classList.add('hidden');
            chatSection.classList.add('hidden');
            navQuiz.classList.remove('bg-indigo-600', 'text-white');
            navChat.classList.remove('bg-indigo-600', 'text-white');
            navQuiz.classList.add('bg-gray-200', 'text-gray-700');
            navChat.classList.add('bg-gray-200', 'text-gray-700');

            if (sectionId === 'quiz') {
                quizSection.classList.remove('hidden');
                navQuiz.classList.add('bg-indigo-600', 'text-white');
                navQuiz.classList.remove('bg-gray-200', 'text-gray-700');
            } else if (sectionId === 'chat') {
                chatSection.classList.remove('hidden');
                navChat.classList.add('bg-indigo-600', 'text-white');
                navChat.classList.remove('bg-gray-200', 'text-gray-700');
            }
        }

        // Initial setup
        switchSection('quiz');

        navQuiz.addEventListener('click', () => switchSection('quiz'));
        navChat.addEventListener('click', () => switchSection('chat'));

        startQuizBtn.addEventListener('click', handleStartQuiz);
        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                renderQuestion();
            } else {
                showResult();
            }
        });
        document.getElementById('restart-quiz-btn').addEventListener('click', () => {
            resultAreaDiv.classList.add('hidden');
            startFormDiv.classList.remove('hidden');
            quizQuestions = [];
        });
        chatForm.addEventListener('submit', handleChatSubmit);

    </script>
</body>

</html>